name: üöÄ Deploy para cPanel

on:
  push:
    branches:
      - main  # ou master, dependendo do seu branch principal
      - production  # adicione outros branches se necess√°rio
  workflow_dispatch:  # Permite executar manualmente

jobs:
  deploy:
    name: üì¶ Deploy via FTP
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout do c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Apenas o √∫ltimo commit para deploy mais r√°pido
      
      - name: üîß Setup PHP (para valida√ß√£o)
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mysqli, pdo, pdo_mysql
      
      - name: ‚úÖ Validar sintaxe PHP
        run: |
          echo "Validando arquivos PHP..."
          find . -name "*.php" -not -path "./vendor/*" -exec php -l {} \; || true
          echo "‚úÖ Valida√ß√£o conclu√≠da (erros ignorados temporariamente)"
      
      - name: üóÇÔ∏è Preparar arquivos para deploy
        run: |
          echo "Removendo arquivos tempor√°rios..."
          find . -name "tmp_rovodev_*" -delete
          find . -name ".DS_Store" -delete
          find . -name "Thumbs.db" -delete
          find . -name "desktop.ini" -delete
          echo "‚úÖ Arquivos tempor√°rios removidos"
      
      - name: üì§ Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT || 21 }}  # Porta padr√£o FTP: 21, FTPS: 21 ou 990
          protocol: ${{ secrets.FTP_PROTOCOL || 'ftp' }}  # 'ftp' ou 'ftps'
          local-dir: ./
          server-dir: ${{ secrets.FTP_SERVER_DIR || '/public_html/' }}
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/tmp_rovodev_*
            **/.vscode/**
            **/.idea/**
            **/*.log
            **/error_log
            **/.DS_Store
            **/Thumbs.db
            **/desktop.ini
            **/config/config.local.php
            **/*.md
            **/uploads/**
            **/.github/**
          dangerous-clean-slate: false  # N√ÉO apagar tudo antes (preserva uploads)
      
      - name: ‚úÖ Deploy conclu√≠do
        run: |
          echo "üéâ Deploy realizado com sucesso!"
          echo "üìÖ Data: $(date)"
          echo "üîó Acesse seu site para verificar"

      - name: üì¢ Notificar no Discord/Slack (Opcional)
        if: success()
        run: |
          echo "Deploy conclu√≠do com sucesso!"
          # Descomente e configure se quiser notifica√ß√µes:
          # curl -X POST -H 'Content-type: application/json' \
          # --data '{"text":"‚úÖ Deploy realizado com sucesso no cPanel!"}' \
          # ${{ secrets.WEBHOOK_URL }}
